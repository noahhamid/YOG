generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Review {
  id        String   @id @default(cuid())
  productId String
  userId    String
  userName  String
  userEmail String
  rating    Int
  comment   String
  helpful   Int      @default(0)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([userId])
  @@index([rating])
}

model Order {
  id              String         @id @default(cuid())
  orderNumber     String         @unique
  customerName    String
  customerPhone   String
  customerEmail   String?
  productId       String
  sellerId        String
  quantity        Int
  selectedSize    String
  selectedColor   String
  unitPrice       Float
  totalPrice      Float
  deliveryFee     Float          @default(0)
  finalTotal      Float
  deliveryMethod  DeliveryMethod
  deliveryAddress String?
  status          OrderStatus    @default(PENDING)
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  product         Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  seller          Seller         @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([sellerId, status])
  @@index([sellerId, createdAt])
  @@index([productId])
  @@index([orderNumber])
}

model User {
  id         String   @id @default(cuid())
  name       String
  email      String   @unique
  phone      String?  @unique
  password   String?
  role       UserRole @default(USER)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  image      String?
  provider   String?
  providerId String?
  reviews    Review[]
  seller     Seller?

  @@index([email])
  @@index([phone])
  @@index([provider])
}

model Seller {
  id               String    @id @default(cuid())
  userId           String    @unique
  brandName        String
  ownerName        String
  phone            String
  email            String
  instagram        String?
  location         String
  clothingType     String
  businessType     String
  experience       String?
  description      String?
  approved         Boolean   @default(false)
  rejectionReason  String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  followers        Int       @default(0)
  storeCover       String?
  storeDescription String?
  storeLogo        String?
  storeSlug        String?   @unique
  totalSales       Int       @default(0)
  totalViews       Int       @default(0)
  followersList    Follow[]  @relation("SellerFollowers")
  orders           Order[]
  products         Product[]
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([storeSlug])
  @@index([approved])
  @@index([userId])
  @@index([approved, storeSlug])  // ✅ ADD THIS
}

model Follow {
  id        String   @id @default(cuid())
  userId    String
  sellerId  String
  createdAt DateTime @default(now())
  seller    Seller   @relation("SellerFollowers", fields: [sellerId], references: [id], onDelete: Cascade)

  @@unique([userId, sellerId])
  @@index([userId])
  @@index([sellerId])
}

model Product {
  id             String           @id @default(cuid())
  sellerId       String
  title          String
  description    String
  price          Float
  compareAtPrice Float?
  category       ProductCategory
  brand          String?
  status         ProductStatus    @default(DRAFT)
  isFeatured     Boolean          @default(false)
  isTrending     Boolean          @default(false)
  tags           String[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  orders         Order[]
  seller         Seller           @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  images         ProductImage[]
  variants       ProductVariant[]
  reviews        Review[]

  @@index([category])
  @@index([isFeatured])
  @@index([isTrending])
  @@index([sellerId])
  @@index([status])
  @@index([sellerId, status])              // ✅ ADD THIS
  @@index([sellerId, status, createdAt])   // ✅ ADD THIS
}

model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  size      String
  color     String
  quantity  Int
  sku       String?
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  url       String
  position  Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([productId, position])  // ✅ ADD THIS
}

enum UserRole {
  USER
  SELLER
  ADMIN
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ProductCategory {
  MEN
  WOMEN
  UNISEX
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum DeliveryMethod {
  DELIVERY
  MEETUP
}
